<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Sock Shop - Demo Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 pb-4 border-b">
            <div>
                <h1 class="text-4xl font-bold text-gray-900">The Sock Shop</h1>
                <p class="text-gray-500">A Demo Application for APIShield+</p>
            </div>
            <div id="auth-controls" class="flex items-center gap-4">
                <!-- This will be populated by JS -->
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <h2 class="text-2xl font-semibold mb-6">Our Products</h2>
            <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Products will be loaded here -->
                <div class="text-center p-8">Loading products...</div>
            </div>
        </main>

        <!-- Cart Section -->
        <section id="cart-section" class="mt-12 p-6 bg-white rounded-lg shadow-md hidden">
            <h2 class="text-2xl font-semibold mb-4">Your Shopping Cart</h2>
            <div id="cart-items">
                <!-- Cart items will be loaded here -->
            </div>
            <div id="cart-total" class="text-right font-bold text-xl mt-4">
                <!-- Cart total will be calculated here -->
            </div>
        </section>

    </div>

    <!-- Login/Register Modal -->
    <div id="auth-modal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-center">Login</h2>
            <form id="auth-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="email" name="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div id="error-message" class="text-red-500 text-center mb-4"></div>
                <button type="submit" id="submit-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Login</button>
            </form>
            <p class="text-center text-sm text-gray-500 mt-4">
                <a href="#" id="switch-mode" class="font-medium text-indigo-600 hover:text-indigo-500">Need an account? Register</a>
            </p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000'; // The backend URL

        const state = {
            products: [],
            cart: [],
            isLoggedIn: false,
            token: null,
            currentUser: null,
            currentPassword: null, // IMPORTANT: Storing password for re-auth demo. NOT FOR PRODUCTION.
            isLoginMode: true,
        };

        // DOM Elements
        const productListEl = document.getElementById('product-list');
        const authControlsEl = document.getElementById('auth-controls');
        const cartSectionEl = document.getElementById('cart-section');
        const cartItemsEl = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const authModalEl = document.getElementById('auth-modal');
        const authFormEl = document.getElementById('auth-form');
        const modalTitleEl = document.getElementById('modal-title');
        const submitButtonEl = document.getElementById('submit-button');
        const switchModeEl = document.getElementById('switch-mode');
        const errorMessageEl = document.getElementById('error-message');

        // --- API Functions ---
        async function apiCall(endpoint, method = 'GET', body = null, headers = {}) {
            const defaultHeaders = { 'Content-Type': 'application/json' };
            if (state.token) {
                defaultHeaders['Authorization'] = `Bearer ${state.token}`;
            }

            const config = {
                method,
                headers: { ...defaultHeaders, ...headers },
            };

            if (body) {
                config.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                if (!response.ok) {
                    // Auto-logout on 401
                    if (response.status === 401) {
                        handleLogout();
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'An API error occurred');
                }
                // Handle responses with no content
                if (response.status === 201 || response.status === 204) {
                    return null;
                }
                return await response.json();
            } catch (err) {
                console.error('API Call Failed:', err);
                errorMessageEl.textContent = err.message;
                throw err;
            }
        }

        // --- Render Functions ---
        function renderProducts() {
            productListEl.innerHTML = '';
            state.products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'bg-white p-6 rounded-lg shadow-md text-center';
                productDiv.innerHTML = `
                    <div class="text-5xl mb-4">ðŸ‘Ÿ</div>
                    <h3 class="text-xl font-bold">${product.name}</h3>
                    <p class="text-gray-600 my-2">$${product.price.toFixed(2)}</p>
                    <button data-product-id="${product.id}" class="add-to-cart-btn mt-4 bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600 disabled:bg-gray-400" ${!state.isLoggedIn ? 'disabled' : ''}>Add to Cart</button>
                `;
                productListEl.appendChild(productDiv);
            });
        }

        function renderAuthControls() {
            authControlsEl.innerHTML = '';
            if (state.isLoggedIn) {
                authControlsEl.innerHTML = `
                    <span class="font-semibold">Welcome, ${state.currentUser}!</span>
                    <button id="logout-btn" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600">Logout</button>
                `;
            } else {
                authControlsEl.innerHTML = `
                    <button id="login-btn" class="bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600">Login / Register</button>
                `;
            }
        }
        
        function renderCart() {
            if (!state.isLoggedIn || state.cart.length === 0) {
                cartSectionEl.classList.add('hidden');
                return;
            }
            cartSectionEl.classList.remove('hidden');
            cartItemsEl.innerHTML = '';
            let total = 0;
            state.cart.forEach(item => {
                total += item.price;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center py-2 border-b';
                itemDiv.innerHTML = `
                    <span>${item.name}</span>
                    <span class="font-semibold">$${item.price.toFixed(2)}</span>
                `;
                cartItemsEl.appendChild(itemDiv);
            });
            cartTotalEl.innerHTML = `Total: $${total.toFixed(2)}`;
        }

        function updateUI() {
            renderAuthControls();
            renderProducts();
            renderCart();
        }

        // --- Event Handlers ---
        function handleLogout() {
            state.isLoggedIn = false;
            state.token = null;
            state.currentUser = null;
            state.currentPassword = null;
            state.cart = [];
            sessionStorage.clear();
            updateUI();
        }

        async function handleAddToCart(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product || !state.currentPassword) return;

            try {
                // This demonstrates the Zero-Trust principle of re-authentication for sensitive actions.
                await apiCall('/shop/cart', 'POST', product, {
                    'X-Reauth-Password': state.currentPassword
                });
                await fetchCart();
            } catch (err) {
                // Error is already logged by apiCall
            }
        }

        // --- Modal Logic ---
        function showModal(isLogin = true) {
            state.isLoginMode = isLogin;
            modalTitleEl.textContent = isLogin ? 'Login' : 'Register';
            submitButtonEl.textContent = isLogin ? 'Login' : 'Register';
            switchModeEl.innerHTML = isLogin ? 'Need an account? Register' : 'Already have an account? Login';
            errorMessageEl.textContent = '';
            authFormEl.reset();
            authModalEl.classList.remove('hidden');
        }

        function hideModal() {
            authModalEl.classList.add('hidden');
        }

        // --- Core Logic ---
        async function fetchProducts() {
            try {
                const products = await apiCall('/shop/products');
                state.products = products;
            } catch (err) {
                // This catch block will execute if the backend is not running or unreachable.
                console.warn("Could not connect to backend. Loading mock product data as a fallback.");
                productListEl.innerHTML = `<div class="col-span-full text-center text-amber-600 bg-amber-100 p-4 rounded-md shadow"><strong>Warning:</strong> Could not connect to the backend server. Displaying mock product data.</div>`;
                state.products = [
                    {"id": 1, "name": "Classic Wool Socks (Mock)", "price": 12.99},
                    {"id": 2, "name": "Sport Ankle Socks (Mock)", "price": 8.50},
                    {"id": 3, "name": "Funky Patterned Socks (Mock)", "price": 15.00}
                ];
            } finally {
                updateUI(); // Render with either real or mock data
            }
        }

        async function fetchCart() {
            if (!state.isLoggedIn) return;
            try {
                const cartItems = await apiCall('/shop/cart');
                state.cart = cartItems;
                updateUI();
            } catch (err) {
                // Error handled in apiCall, UI will reflect logged-out state if necessary
            }
        }

        async function handleAuthSubmit(event) {
            event.preventDefault();
            errorMessageEl.textContent = '';
            const email = event.target.email.value;
            const password = event.target.password.value;

            try {
                if (state.isLoginMode) {
                    // Login
                    const formData = new URLSearchParams();
                    formData.append('username', email);
                    formData.append('password', password);

                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: formData,
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Login failed');
                    }
                    const data = await response.json();
                    
                    state.token = data.access_token;
                    state.isLoggedIn = true;
                    state.currentUser = email;
                    state.currentPassword = password; // Store for demo
                    sessionStorage.setItem('appState', JSON.stringify({token: state.token, currentUser: state.currentUser, currentPassword: state.currentPassword}));
                    hideModal();
                    await fetchCart();
                    updateUI();

                } else {
                    // Register
                    await apiCall('/auth/register', 'POST', { email, password });
                    alert('Registration successful! Please log in.');
                    showModal(true); // Switch to login mode
                }
            } catch (err) {
                 errorMessageEl.textContent = err.message;
            }
        }

        // --- Initialization ---
        function init() {
            // Event Listeners
            document.addEventListener('click', (e) => {
                if (e.target.id === 'login-btn') showModal(true);
                if (e.target.id === 'logout-btn') handleLogout();
                if (e.target.matches('.add-to-cart-btn')) {
                    handleAddToCart(parseInt(e.target.dataset.productId));
                }
                if (e.target.id === 'switch-mode') {
                    e.preventDefault();
                    showModal(!state.isLoginMode);
                }
                 if (e.target === authModalEl) {
                    hideModal();
                }
            });

            authFormEl.addEventListener('submit', handleAuthSubmit);

            // Check for saved session
            const savedState = sessionStorage.getItem('appState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                state.token = parsedState.token;
                state.currentUser = parsedState.currentUser;
                state.currentPassword = parsedState.currentPassword;
                state.isLoggedIn = true;
                fetchCart();
            }

            fetchProducts();
        }

        init();
    </script>
</body>
</html>
